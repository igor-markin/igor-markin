# Шпаргалка по Django

## Миграции

**ValueError: Lookup failed for model referenced by field app1.ModelName1.field: app2.ModelName2**

**Проблема.** После неправильного удаления миграций и создания новых может возникнуть ошибка циклического импорта. Это когда initial-миграция одного приложения зависит от initial другого приложения, а то в свою очередь зависит обратно от первого. Велик соблаз закомментировать зависимости, потому что тогда проект запустится. Это чревато тем, что во время последующих миграций можно поймать ошибку ```Lookup failed for model referenced by field```. Она появлятся, когда Django имеет внешний ключ, но не понимает, откуда брать о нём информацию. Проблема как раз в закомментированных зависимостях.

**Решение.** Всё легко и сложно одновременно. Легко, потому что всё, что нужно сделать — вынести поля с внешними ключами в отдельную миграцию. Сложно, потому что придётся подойти к вопросу внимательно, не запутаться и не удалить лишнее. При этом изначально они будут находиться в блоке ```CreateModel``` файла миграции ```0001_initial.py```, например:

```python
dependencies = [
        ('app2', '0001_initial'),  # Переносить в новый файл будем зависимость
    ]

operations = [
        migrations.CreateModel(
            name='ModelName1',
            fields=[
                ('field_name', models.ForeignKey(verbose_name='My field', to=app.ModelName2)),  # И поле с внешним ключом
```

Перенести поля нужно в новый файл ```0002_filename.py```, поменяв блок ```CreateModel``` на ```AddField```. Важно не забыть перенести зависимость:

```python
dependencies = [
        ('app2', '0001_initial'),
    ]

operations = [
        migrations.AddField(
            model_name='modelname1',  # Название модели пишем маленькими буквами
            name='field_name',
            field=models.ForeignKey(verbose_name='My field', to=app.ModelName),
        ),
    ]
```

Если всё сделано правильно — нужно будет применить ключ ```--fake``` к миграциям таблиц, которые уже есть в базе данных и всё вернётся обратно в мирное русло.
